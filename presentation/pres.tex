\documentclass[page number,usenames,dvipsnames]{beamer}
\usetheme[sectionpage=none,numbering=fraction,progressbar=foot]{metropolis}

\usepackage{pgf,tikz}
\usetikzlibrary{arrows}
\usetikzlibrary{positioning,shapes,fit}
\usepackage{graphicx}
\usepackage{amsmath,amssymb,amsthm,textcomp}
\usepackage{proof}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{pgf,tikz}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{wrapfig}
\usetikzlibrary{positioning,shapes}
\usepackage{multicol}
\usepackage{btreecursor}
\usepackage{lstcoq}

\definecolor{spec}{HTML}{6F1616}
\definecolor{prog}{HTML}{106235}
\def\spec#1{{\color{spec}\textbf{#1}}}
\def\prog#1{{\color{prog}\textbf{#1}}}
\newcommand{\wand}{\mathrel{-\hspace{-.7ex}*}}

\makeatletter
\makeatother

\setcounter{tocdepth}{1} % remove subsection from table of contents

% colors
\definecolor{mDarkRed}{HTML}{6F1616}
\definecolor{mDarkGreen}{HTML}{106235}
\definecolor{mTeal}{HTML}{112233}
\definecolor{mBlack}{HTML}{000000}
\setbeamercolor{normal text}{fg=mTeal}
\setbeamercolor{alerted text}{fg=mDarkRed}
\setbeamercolor{example text}{fg=mDarkGreen}
\setbeamercolor{title separator}{fg=purple,bg=mBlack}

\def\outline{
  \begin{frame}[plain,noframenumbering]
    \frametitle{Outline}
    \tableofcontents[currentsection]
  \end{frame}
}

\def\btree{B+Tree}
\def\btrees{B+Trees}
\def\todo#1{{\color{red}#1}}
\def\btrep{\texttt{btnode\_rep}}

\begin{document}
\title[shorttitle]{VST Verification of B+Trees with Cursors}

\author[Aur\`ele Barri\`ere]{Aur\`ele Barri\`ere}

\date{\textit{ENS Rennes}
  \vfill
  \textbf{March 1st, 2018 - June 29th, 2018}}

\def\outline{
  \begin{frame}[plain,noframenumbering]
    \frametitle{Outline}
    \tableofcontents[currentsection]
  \end{frame}
}

\include{figures}

\begin{frame}[plain,noframenumbering]
  \vspace{-2cm}
  \maketitle
  \vspace{-4cm}
\end{frame}

%% \metroset{sectionpage=none}

%% \metroset{sectionpage=progressbar}

\section{Introduction}
\begin{frame}{Introduction}
  % introduction to software verif
  \begin{block}{DeepSpecDB}
    \begin{itemize}
    \item Define, specify and verify a high-performance concurrent in-memory database system.
    \item Based on MassTree, uses \btrees
    \item C sequential library for \btrees\ with cursors
    \item Coq abstract relation with cursors specification
    \end{itemize}
  \end{block}
  \vfill
  \begin{exampleblock}{Outline}
    \begin{itemize}
    \item Fix the C library
    \item Define a Coq formal model for \btrees\ with cursors
    \item Prove the correctness of the C library using VST
    \end{itemize}
  \end{exampleblock}
      
\end{frame}

\begin{frame}{B+Trees}
  % presentation of B+Trees library
  \beforeinsert
  \vfill
  % properties
  \begin{multicols}{2}
    \begin{exampleblock}{Properties}
      \begin{itemize}
      \item Ordered
      \item Balanced
      \item Fanout
      \end{itemize}
    \end{exampleblock}
      \begin{block}{Operations}
        \begin{itemize}
        \item Insert key and record
        \item Get record of given key
        \item {\color{mDarkRed}Delete record of given key}
        \item Range queries
        \end{itemize}
      \end{block}
  \end{multicols}

  % operations
\end{frame}

\begin{frame}{B+Trees Insertion}
  \beforeinsert
  \vfill
  \pause
  \afterinsert
\end{frame}

\begin{frame}{Cursors}
  % example.
  \cursor
  \vfill
  % operations
  \begin{block}{Operations}
    \begin{itemize}
    \item Insert key and record
    \item Get record pointed to by the cursor
    \item Move cursor to given key
    \item Move cursor to next or previous key
    \item Move cursor to first or last key
    \end{itemize}
  \end{block}
  % complexity
\end{frame}

\newcommand{\hoare}[3]{\{\spec{$#1$}\}~\prog{$#2$}~\{\spec{$#3$}\}}

\section{VST}
\begin{frame}{Hoare Logic}
  \begin{block}{Hoare Logic}
    \begin{itemize}
    \item \spec{Specification} language
    \item \prog{Program} language
    \item Logic rules to prove \textbf{Hoare Triples}
    \end{itemize}
  \end{block}
  \vfill
  \begin{block}{Hoare Triple}
    $$\{ \spec{$\phi$} \}\quad \prog{S} \quad\{ \spec{$\psi$} \}$$
    \begin{center}
      Precondition\quad Program\quad Postcondition
    \end{center}
  \end{block}
  \vfill
  \begin{exampleblock}{Hoare Triple's meaning}
    Any terminating execution of \prog{S} from a state where \spec{$\phi$} holds
    ends on a state where \spec{$\psi$} holds.
  \end{exampleblock}
\end{frame}

\begin{frame}{Hoare Logic's Rules}
  % Hoare triples
  \centering
  \renewcommand{\arraystretch}{3}
  \begin{tabular}{l c}
  composition: & \infer{\hoare{P}{S_1;S_2}{R}}{\hoare{P}{S_1}{Q}\quad\hoare{Q}{S_2}{R}}\\
  conditional: & \infer{\hoare{P}{\textbf{if}~E~\textbf{then}~S_1~\textbf{else}~S_2}{Q}}{\hoare{P\wedge E}{S_1}{Q}& \quad\hoare{P\wedge\neg E}{S_2}{Q}}\\
  while: & \infer{\hoare{P}{\textbf{while}~E~\textbf{do}~S}{P\wedge\neg E}}{\hoare{P\wedge E}{S}{P}}\\
  assignment: & \infer{\hoare{Q[e/x]}{x:=e}{Q}}{}\\
  consequence: & \infer{\hoare{P}{S}{Q}}{P\rightarrow P'\quad\hoare{P'}{S}{Q'}\quad Q\rightarrow Q'}
  \end{tabular}

\end{frame}

%% \begin{frame}{Separation Logic: an extension of Hoare Logic}
%%   \begin{block}{Separating Conjunction}
%%     $P_1~*P_2$ means that $P_1$ and $P_2$ hold on disjoint parts of the memory.
%%   \end{block}
%%   \vfill
%%   \begin{block}{Separating Implication, Magic Wand}
%%     $P_1\wand P_2$ ...
%%   \end{block}
%%   \todo{...}
%%   % don't think this is needed for the presentation
%% \end{frame}
\section{Verification}
\begin{frame}{The Verified Software Toolchain}

  \begin{block}{Verifiable C}
    Subset of CompCert's Clight.
  \end{block}
  \vfill
  \begin{block}{Program Logic}
    Higher-order Separation Logic, an extension of Hoare Logic.
  \end{block}
  \vfill
  \begin{block}{Using VST}
    \begin{itemize}
    \item Generate an equivalent Clight program
    \item Define a formal model
    \item Write specifications for each functions ($\approx$ Hoare Triple)
    \item Prove each function correct
    \end{itemize}
  \end{block}
  
\end{frame}

\begin{frame}{A B+Tree with Cursors formal model}

  % types
  % example function, movetonext
  
\end{frame}

\begin{frame}[fragile]{Specifying a C program with VST}
 \begin{lstlisting}[language=Coq,basicstyle=\scriptsize]
Definition moveToFirst_spec : ident * funspec :=
  DECLARE _moveToFirst
  WITH r:relation val, c:cursor val, pc:val, n:node val
  PRE[ _node OF tptr tbtnode, _cursor OF tptr tcursor, _level OF tint ]
    PROP(partial_cursor c r; next_node c (get_root r) = Some n)
    LOCAL(temp _cursor pc; temp _node (getval n);
          temp _level (Vint(Int.repr(Zlength c))))
    SEP(relation_rep r; cursor_rep c r pc)
  POST[ tvoid ]
    PROP()
    LOCAL()
    SEP(relation_rep r; cursor_rep (moveToFirst n c (length c)) r pc).
\end{lstlisting}
\end{frame}

\begin{frame}{Proving a C program correct with VST}

  % step through a proof?
  % forward, forward_if, forward_proof
  % prove array in range etc...
  
\end{frame}

\begin{frame}{Proving each function correct}

  % results.
  % anything left to prove?

\end{frame}

\begin{frame}{Bugs of the Original Implementation}
  
  % buildnig cursor for non key values
  % wrong array access
  % wrong complexity
  % others
\end{frame}

\section{Future Work}
\begin{frame}{DeepSpecDB}
  % towards a high-performance database like MassTree
  % Tries of Btrees. How does that work with the proofs

\end{frame}
  
\end{document}
